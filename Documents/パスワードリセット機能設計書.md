# パスワードリセット機能設計書

## 1. 概要

プロファイルページ（`/profile`）に、ログイン済みユーザーが自分のメールアドレスにパスワードリセットメールを送信できる機能を追加します。

## 2. 機能要件

### 2.1 基本機能

- ログイン済みユーザーがプロファイルページからパスワードリセットメールを送信できる
- メールアドレスは自動的に現在ログインしているユーザーのメールアドレスを使用
- メール送信後、成功メッセージを表示
- セキュリティのため、メールアドレスの存在有無に関わらず成功メッセージを表示（情報漏洩防止）

### 2.2 既存機能との関係

- **パスワード変更機能**（既存）: ログイン済みユーザーが現在のパスワードを確認して新しいパスワードに変更
- **パスワードリセット機能**（追加）: ログイン済みユーザーがメールアドレスにリセットメールを送信し、メールリンクから新しいパスワードを設定

## 3. 技術仕様

### 3.1 サーバー側（`front/app/actions/auth.ts`）

既存の`resetPassword`関数を活用します。この関数は既に実装済みで、以下の機能を提供します：

```typescript
export async function resetPassword(
  email: string
): Promise<ResetPasswordResult>
```

**機能詳細:**
- メールアドレスのバリデーション
- Supabaseの`resetPasswordForEmail`を使用してパスワードリセットメールを送信
- リダイレクトURLは`/auth/reset-password`に設定
- セキュリティのため、メールアドレスの存在有無に関わらず成功メッセージを返す

**改善点（必要に応じて）:**
- レート制限の追加（短時間での連続送信を防ぐ）
- エラーハンドリングの強化

### 3.2 クライアント側（`front/app/profile/page.tsx`）

プロファイルページに以下の機能を追加：

1. **パスワードリセットメール送信セクション**
   - 現在のユーザーのメールアドレスを表示
   - 「パスワードリセットメールを送信」ボタン
   - 送信状態の表示（ローディング、成功、エラー）

2. **UI配置**
   - アカウント情報表示エリアの下
   - パスワード変更フォームの上または下に配置

## 4. UI設計

### 4.1 レイアウト

```
┌─────────────────────────────────┐
│  Lingo Leap - マイページ         │
├─────────────────────────────────┤
│ アカウント情報                   │
│ メールアドレス: user@example.com │
├─────────────────────────────────┤
│ パスワードリセットメール送信      │ ← 新規追加
│ [パスワードリセットメールを送信] │
├─────────────────────────────────┤
│ パスワード変更                   │
│ [既存のフォーム]                 │
└─────────────────────────────────┘
```

### 4.2 UI要素

**パスワードリセットメール送信セクション:**
- タイトル: "パスワードリセットメール送信"
- 説明文: "パスワードを忘れた場合は、登録済みのメールアドレスにリセットメールを送信できます。"
- メールアドレス表示: 現在のユーザーのメールアドレス（読み取り専用）
- 送信ボタン: "パスワードリセットメールを送信"
- 結果メッセージ表示エリア:
  - 成功時: 緑色の背景で成功メッセージ
  - エラー時: 赤色の背景でエラーメッセージ

### 4.3 スタイリング

- 既存のプロファイルページのデザインと統一
- Tailwind CSSを使用
- ダークモード対応
- レスポンシブデザイン

## 5. フロー

### 5.1 パスワードリセットメール送信フロー

```
1. ユーザーがプロファイルページにアクセス
2. 「パスワードリセットメール送信」セクションを確認
3. 「パスワードリセットメールを送信」ボタンをクリック
4. サーバー側でresetPassword関数を呼び出し
5. Supabaseがパスワードリセットメールを送信
6. 成功メッセージを表示
7. ユーザーがメールボックスを確認
8. メール内のリンクをクリック
9. /auth/reset-passwordページにリダイレクト
10. 新しいパスワードを設定
11. ログイン画面にリダイレクト
```

## 6. セキュリティ考慮事項

### 6.1 既存のセキュリティ対策

- メールアドレスの存在有無を推測させない（常に成功メッセージを返す）
- Supabaseのセキュアなパスワードリセット機能を使用
- リセットトークンは有効期限付き

### 6.2 追加検討事項

- **レート制限**: 短時間での連続送信を防ぐ（例: 1時間に3回まで）
- **ログ記録**: セキュリティ監査のため、リセットリクエストをログに記録
- **通知**: ユーザーにリセットリクエストがあったことを通知（メール送信時）

## 7. エラーハンドリング

### 7.1 クライアント側

- ネットワークエラー: "ネットワークエラーが発生しました。しばらくしてから再度お試しください。"
- バリデーションエラー: "有効なメールアドレスを入力してください。"
- その他のエラー: "予期しないエラーが発生しました。"

### 7.2 サーバー側

- Supabase APIエラー: エラーメッセージを適切に処理
- バリデーションエラー: 明確なエラーメッセージを返す
- 予期しないエラー: ログに記録し、汎用的なエラーメッセージを返す

## 8. 実装チェックリスト

### 8.1 サーバー側（`auth.ts`）

- [ ] `resetPassword`関数の動作確認
- [ ] エラーハンドリングの確認
- [ ] レート制限の実装（オプション）
- [ ] ログ記録の実装（オプション）

### 8.2 クライアント側（`profile/page.tsx`）

- [ ] パスワードリセットメール送信セクションの追加
- [ ] UIコンポーネントの実装
- [ ] 状態管理（ローディング、成功、エラー）
- [ ] エラーハンドリング
- [ ] レスポンシブデザインの確認
- [ ] ダークモード対応の確認

### 8.3 テスト

- [ ] 正常系: メール送信成功
- [ ] 異常系: ネットワークエラー
- [ ] 異常系: 無効なメールアドレス
- [ ] UI/UX: ローディング状態の表示
- [ ] UI/UX: 成功メッセージの表示
- [ ] UI/UX: エラーメッセージの表示

## 9. 既存コードとの統合

### 9.1 既存の`resetPassword`関数

`front/app/actions/auth.ts`の`resetPassword`関数は既に実装済みで、以下の機能を提供：

- メールアドレスのバリデーション
- Supabaseの`resetPasswordForEmail`を使用
- リダイレクトURLの設定（`/auth/reset-password`）
- セキュリティを考慮したレスポンス

### 9.2 既存の`/auth/reset-password`ページ

`front/app/auth/reset-password/page.tsx`は既に実装済みで、メールリンクから遷移したユーザーが新しいパスワードを設定できる。

## 10. 今後の拡張可能性

- レート制限の実装
- リセットリクエストの履歴表示
- メール送信の通知機能
- 複数のメールアドレスへの対応

