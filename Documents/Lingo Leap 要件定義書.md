Lingo Leap 要件定義書

1. はじめに
   本ドキュメントは、英語学習チャット UI システム「Lingo Leap」の開発における要件を定義するものです。Lingo Leap は、Gemini のようなチャット UI を通じて、ユーザーが AI との対話形式で英語学習を進められることを目的とします。
2. システム概要
   Lingo Leap は、AI とのチャットを通じてユーザーが英語を学習できる Web アプリケーションまたはモバイルアプリケーションです。ユーザーは AI からのメッセージに対して、学びたい内容を送信することで、その内容に関連する複数の英語表現や例文を提示されます。これらのメッセージには音声再生機能とブックマーク機能が備わっており、効果的な学習をサポートします。
3. 機能要件
   3.1. ユーザーインターフェース (UI)
   チャット UI:
   Gemini のような対話型のチャット UI を採用します。
   AI からのメッセージとユーザーからのメッセージが明確に区別できるように表示されます。
   メッセージ表示:
   AI からのメッセージは、ユーザーが学びたい内容を送信した後に、それぞれ別の吹き出しで 3 つ表示されます。
   各吹き出しには以下のアイコンが表示されます。
   音声アイコン
   ブックマークアイコン
   3.2. コア機能
   AI との対話:
   AI は、ユーザーが入力した「学びたい内容」に基づいて、関連性の高い英語のメッセージ（単語、フレーズ、例文など）を生成し、3 つの異なる吹き出しで提示します。
   AI は、自然な対話の流れを維持し、ユーザーの学習レベルや興味に応じた内容を提供します。
   音声再生機能 (発音確認):
   各吹き出しに表示される音声アイコンをタップまたはクリックすることで、該当する英語メッセージのネイティブスピーカーによる発音を再生します。
   再生速度は設定画面で指定した速度（ゆっくり: 0.7 倍速、ふつう: 1.0 倍速、はやい: 1.3 倍速）に従います。
   声のタイプも設定画面で指定したタイプ（デフォルト、女性 1、男性 1）に従います。
   再生中はアイコンが停止アイコンに変化し、タップすることで再生を停止できます。
   ブックマーク機能:
   各吹き出しに表示されるブックマークアイコンをタップまたはクリックすることで、該当する英語メッセージを「ブックマーク英語一覧」に保存します。
   ブックマークされた内容は、後からいつでも閲覧・学習できます。
   ブックマーク管理:
   「ブックマーク英語一覧」画面を提供します。
   一覧からブックマークされた英語メッセージを削除する機能を提供します。
   削除操作時には、モーダルダイアログなどを表示し、ユーザーに削除の意思を確認します。
   3.3. ユーザー管理（仮）
   ユーザーはアカウントを作成し、ログインして学習データを永続化できるものとします。（今後の拡張として検討）
   認証機能:
   - 新規登録: メールアドレスとパスワードによるアカウント作成
   - ログイン: メールアドレスとパスワードによる認証
   - OAuth 認証: Google アカウントによるログイン・新規登録
     - Google OAuth: Google アカウントでログイン・登録が可能
     - OAuth 認証は既存のメール/パスワード認証と同等の機能を提供
     - OAuth 認証成功後は自動的にアカウントが作成され、ログイン状態になる
   - ログアウト: セッションの終了
   - パスワードリセット: パスワードを忘れた場合、メールアドレスにリセットリンクを送信
   - パスワード変更: ログイン済みユーザーが現在のパスワードを確認して新しいパスワードに変更
     - セキュリティのため、現在のパスワードの確認が必須
     - 新しいパスワードは 6 文字以上で、現在のパスワードと異なる必要がある
4. 非機能要件
   4.1. パフォーマンス
   AI からのメッセージ生成、音声再生、ブックマーク保存/表示は、ユーザーがストレスなく利用できる速度で応答すること。
   特に AI からの 3 つのメッセージ生成は、数秒以内に完了することを目標とします。
   4.2. スケーラビリティ
   将来的なユーザー数の増加や機能拡張に対応できるよう、拡張性のあるアーキテクチャ設計とします。
   4.3. セキュリティ
   ユーザーの個人情報や学習データは適切に保護されること。
   SSL/TLS による通信の暗号化を必須とします。
   4.4. ユーザビリティ
   直感的で分かりやすい UI/UX を提供し、英語学習が楽しく継続できるような体験を目指します。
   アクセシビリティにも配慮します。
   4.5. 信頼性
   システムは安定稼働し、サービス中断は最小限に抑えられること。
   障害発生時には、迅速な復旧が可能な体制を構築します。
5. 技術要件（選定技術）
   5.1. フロントエンド
   Next.js（App Router）+ TypeScript を採用します。UI フレームワークとして Tailwind CSS を想定します。

   - ルーティング: Next.js App Router
   - 状態管理: 軽量なローカルステート（必要に応じて React Query など）
   - 音声再生: ブラウザの Audio API を基本とし、TTS 生成音声の再生に対応
   - Next.js 設定: `next.config.ts` にて開発環境のインジケーター（N マーク）を非表示に設定

     - `devIndicators: false` を設定することで、開発サーバー起動時の左下に表示される「N」マークを非表示にします
     - 設定ファイル: `front/next.config.ts`
     - 設定例:

       ```typescript
       import type { NextConfig } from "next";

       const nextConfig: NextConfig = {
         devIndicators: false,
       };

       export default nextConfig;
       ```

       5.2. バックエンド（API）
       Next.js の Route Handlers（Edge/Node ランタイム）を用いて API を実装します。

   - AI 応答生成: ai-sdk を利用して LLM（例: OpenAI/Gemini 等）にリクエスト
   - レート制御/ストリーミング: ai-sdk のストリーミング応答に対応

     5.3. 認証/データベース
     Supabase を採用します。

   - 認証: Supabase Auth（メール/パスワード、OAuth など）
   - データベース: Supabase Postgres（ブックマーク、学習履歴等の永続化）
   - API アクセス: Supabase JavaScript SDK による RLS 前提の安全なアクセス

     5.4. AI/ML
     ai-sdk を通じて選定 LLM の API と連携します。

   - モデル切替: 環境変数によりプロバイダ/モデルを切替可能に設計
   - 生成内容: ユーザー入力に基づき英語表現を 3 通り生成

     5.5. 音声合成（TTS）
     初期はブラウザの読み上げ/外部 TTS API のいずれかを使用可能とします（将来拡張）。

   - 候補: Vercel AI SDK 経由での TTS、あるいは外部サービス（例: ElevenLabs, Azure TTS 等）

     5.6. デプロイ/ホスティング

   - アプリ: Vercel にデプロイ（Preview/Production 環境）
   - データベース/認証: Supabase プロジェクトにホスト
   - 監視: Vercel Analytics（必要に応じて追加の監視を導入）

     5.7. アーキテクチャ概要

   - フロントエンド（Next.js）から Route Handler 経由で ai-sdk を呼び出し、3 件の英語メッセージを生成
   - ブックマーク操作はフロントエンドから Supabase に対して実施（RLS/ポリシーによりユーザー毎に保護）
   - 認証は Supabase Auth を利用し、ログイン状態に応じた表示/保存を制御

     5.8. 環境変数（例）

   - LLM プロバイダ鍵: AI_PROVIDER_API_KEY
   - Supabase: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY
   - 任意: TTS プロバイダ鍵（採用時）

     5.9. Favicon（サイトアイコン）

   - ブラウザのタブやブックマークに表示されるサイトのアイコンを設定します。
   - ファイル形式: `.ico`形式（推奨サイズ: 32x32px、複数サイズを含むマルチアイコン形式）
   - 配置場所: `front/app/favicon.ico`
   - Next.js の App Router では、`app`ディレクトリに配置された`favicon.ico`が自動的に認識されます。
   - `layout.tsx`の metadata で明示的に favicon を指定することで、ブラウザに正しいアイコンを確実に表示させます。
   - ブランドロゴやサービス名の頭文字（例: "L"）などを使用し、視認性の高いデザインとします。

6. 設定機能
   6.1. 概要
   ユーザーがアプリの動作や見た目をカスタマイズできる設定ページを提供します。設定値はユーザー単位で永続化され、再ログイン時にも前回の設定が復元されます。

   6.2. 学習レベル設定

   - 目的: ユーザーの英語レベルに応じた学習コンテンツの難易度を調整するための設定
   - 概要: 3 段階のレベル（やさしい/ふつう/チャレンジ）から選択可能
   - ユーザーストーリー:

     - ユーザーは自分の英語レベルに合わせて学習難易度を選択できる
     - 選択したレベルは将来の AI 応答生成に反映される（将来拡張）
     - デフォルト値は「ふつう」とする

       6.3. 音声設定

   - 目的: チャットの読み上げ機能に関する設定を提供
   - 概要: 読み上げの有効/無効、速度、声の種類を設定可能
   - ユーザーストーリー:

     - ユーザーは読み上げ機能を ON/OFF できる（OFF の場合、チャット画面の音声ボタンは非表示）
     - ユーザーは読み上げ速度（ゆっくり: 0.7 倍速、ふつう: 1.0 倍速、はやい: 1.3 倍速）を選択できる
     - ユーザーは声のタイプ（デフォルト、女性 1、男性 1）を選択できる
     - 設定はチャット画面の音声再生に即座に反映される（カスタムイベント経由）
     - チャット画面には 1 つの音声ボタンが表示され、設定画面で指定した速度と声のタイプで再生される

       6.4. テーマ設定

   - 目的: 画面の見た目をユーザーの好みに合わせてカスタマイズ
   - 概要: カラーテーマ（ライト/ダーク）とフォントサイズ（小さめ/ふつう/大きめ）を設定可能
   - ユーザーストーリー:

     - ユーザーはライトモードとダークモードを切り替えられる
     - ユーザーは文字サイズを調整できる
     - 設定変更は即座に画面全体に反映される
     - 設定は再ログイン時にも維持される

       6.5. 学習履歴の記録設定

   - 目的: ユーザーが自分の学習進捗をグラフで確認するために、学習活動の記録を選択できるようにする
   - 概要: 学習活動（チャット・音声再生・ブックマーク）を記録し、学習履歴ページでグラフとして可視化
   - ユーザーストーリー:
     - ユーザーは学習活動の記録を有効/無効にできる
     - 記録を有効にすると、学習ログがデータベースに記録される
     - 記録を無効にすると、新しいログは記録されないが、過去のデータは閲覧可能
     - 記録されたデータは「学習履歴可視化」ページでグラフとして表示される

7. 学習分析機能
   7.1. 概要
   ユーザーの学習活動を記録・分析し、学習の進捗を可視化する機能を提供します。記録設定で許可されている場合のみ、学習ログが記録されます。

   7.2. 学習ログの記録
   以下のイベントを自動的に記録します:

   - チャット送信: ユーザーがメッセージを送信したとき
   - 音声再生: 英語表現の音声が再生されたとき
   - ブックマーク追加/削除: ブックマークの追加・削除が行われたとき

   各ログには以下の情報が含まれます:

   - イベントタイプ（chat_send, audio_play, bookmark_add, bookmark_remove）
   - ユーザーの学習レベル（イベント発生時点）
   - メタデータ（メッセージ ID、音声速度、声のタイプなどイベント固有の情報）
   - タイムスタンプ

     7.3. 学習履歴可視化
     専用の「学習履歴」ページで、以下の統計情報を可視化します:

   - **サマリーカード**: チャット送信回数、音声再生回数、ブックマーク件数の総計
   - **日別推移グラフ**: 各活動の日別推移を折れ線グラフで表示
   - **活動内訳グラフ**: 活動タイプ別の総計を棒グラフで表示
   - **期間選択**: 7 日間、30 日間、90 日間から表示期間を選択可能

     7.4. データとプライバシーの保護

   - 記録設定で「学習活動を記録する」を無効にしている場合、新しいログは一切記録されません
   - 個人の学習履歴表示は、記録設定に関わらず常に利用可能です（自分のデータのみ）
   - 記録を無効にした場合でも、過去に記録されたデータは保持され、閲覧できます
   - 記録されるデータはユーザー自身の学習進捗確認のためのものであり、個人を特定できる機密情報は含まれません
   - データベースの Row Level Security (RLS) により、ユーザーは自分のログのみにアクセス可能です

     7.5. 技術実装

   - データベース: `study_logs` テーブルを使用してログを永続化
   - セキュリティ: Row Level Security (RLS) により、ユーザーは自分のログのみにアクセス可能

- 可視化: Recharts ライブラリを使用してグラフを描画
- 性能: インデックスを適切に設定し、大量のログでも高速に集計可能

8. クイズ／ゲーム機能
   8.1. 概要
   ユーザーが楽しみながら英語を学べる「英語並び替えゲーム」を提供します。シャッフルされた単語を正しい順番に並び替えることで、英語の語順と文法を効果的に学習できます。

   8.2. スタート画面（ゲーム開始前）

ゲームページ（`/quiz`）にアクセスすると、まずスタート画面が表示されます。いきなりゲームが始まるのではなく、ユーザーが準備できてから開始できるようにします。

**スタート画面の構成**:

- **ゲームの説明**:

  - 10 問の英語並び替え問題に挑戦
  - 各問題 30 秒の制限時間
  - ドラッグ＆ドロップまたはクリックで並び替え
  - 学習レベルに応じた難易度調整

- **前回のスコア表示**:

  - 前回プレイ時のスコア（点数、正解数、日付）を表示
  - localStorage に保存され、次回アクセス時に表示
  - 初回プレイ時は表示されない

- **現在の学習レベル表示**:

  - 設定ページで設定された学習レベル（やさしい/ふつう/チャレンジ）を表示
  - 「設定を変更」リンクから設定ページへ遷移可能

- **難易度の一時選択**:

  - 3 つの難易度ボタンから選択可能（やさしい/ふつう/チャレンジ）
  - デフォルトは現在の設定レベルが選択された状態
  - ここで選択した難易度は今回のゲームにのみ適用される
  - 次回アクセス時は設定ページの学習レベルに戻る

- **ゲーム開始ボタン**:

  - 「🎮 ゲームを開始」ボタンをクリックすると問題生成が始まる
  - ローディング画面を経て、ゲーム画面に遷移

- **ホームに戻るリンク**:
  - ゲームをプレイせずにホームページに戻ることができる

**ユーザーストーリー**:

- ユーザーはゲームのルールと制限時間を事前に確認できる
- ユーザーは前回のスコアを確認してモチベーションを高められる
- ユーザーは設定を変えずに、その場で難易度を変更してプレイできる
- ユーザーは準備ができたタイミングで自らゲームを開始できる

  8.3. ゲームの流れ

1. **スタート画面**: ゲームの説明、難易度選択、「ゲームを開始」ボタン
1. **問題生成**: 選択した難易度に応じて、AI が 10 問の英語文章を動的に生成
1. **並び替え**: 各問題で、シャッフルされた単語をドラッグ&ドロップまたはクリックで正しい順番に並び替え
1. **回答**: 「回答する」ボタンをクリックして正誤判定
1. **フィードバック**: 正解/不正解が表示され、不正解の場合は正しい答えが表示される
1. **次の問題**: 自動的に次の問題へ移動（全 10 問）
1. **結果表示**: 全問終了後、スコア・正解率・平均時間・間違えた問題を表示
1. **スコア保存**: 結果が localStorage に自動保存され、次回のスタート画面で表示

8.4. 主な機能

**問題生成**:

- AI が学習レベル（やさしい/ふつう/チャレンジ）に応じた英文を 10 問生成
- やさしい: 3-6 語の基本的な文章（日常会話）
- ふつう: 5-9 語の自然な文章（日常生活）
- チャレンジ: 8-12 語の洗練された文章（ビジネス・フォーマル）

**タイマー機能**:

- 各問題に 30 秒の制限時間
- 視覚的なプログレスバーで残り時間を表示
- 残り 10 秒以下で警告色（赤）に変化
- タイムアップ時は不正解扱いで自動的に次の問題へ

**スコアシステム**:

- 正解数/総問題数
- 正解率（パーセンテージ）
- 平均回答時間（秒）
- 問題ごとの回答時間記録

**ユーザー操作**:

- ドラッグ&ドロップで単語を並び替え（デスクトップ）
- クリック/タップで単語を順番に追加（モバイル対応）
- 「やり直し」ボタンで回答をリセット
- 「スキップ」ボタンで問題をスキップ

**結果画面**:

- 総合スコア（100 点満点）
- 正解数と正解率
- 平均回答時間
- 間違えた問題の一覧（日本語、自分の回答、正解を表示）
- 「もう一度プレイ」ボタンで再挑戦
- 「ホームに戻る」ボタン

  8.5. 学習ログとの連携

クイズプレイが完了すると、以下の情報が学習ログ（`study_logs`テーブル）に記録されます:

- イベントタイプ: `quiz_play`
- メタデータ:
  - `quiz_type`: `sentence_scramble`（並び替えゲーム）
  - `total_questions`: 総問題数（10 問）
  - `correct_answers`: 正解数
  - `score`: スコア（正解率の 100 点満点換算）
  - `total_time`: 総プレイ時間（秒）

記録されたデータは「学習履歴可視化」ページで他の学習活動とともに可視化されます。

8.6. ユーザーストーリー

**スタート画面**:

- ユーザーはサイドバーから「クイズ／ゲーム」をクリックして、スタート画面にアクセスできる
- ユーザーはゲームのルールと制限時間を事前に確認できる
- ユーザーは前回のスコアを確認してモチベーションを高められる
- ユーザーは設定を変えずに、その場で難易度を変更してプレイできる
- ユーザーは「設定を変更」リンクから設定ページへ移動し、学習レベルを恒久的に変更できる
- ユーザーは準備ができたタイミングで「ゲームを開始」ボタンをクリックできる

**ゲームプレイ**:

- ユーザーは自分が選択した難易度の問題に挑戦できる
- ユーザーは 30 秒以内に各問題を解答する必要がある
- ユーザーはドラッグ&ドロップまたはクリックで直感的に単語を並び替えられる
- ユーザーは即座に正誤のフィードバックを受けられる
- ユーザーはゲーム終了後、詳細なスコアと間違えた問題を確認できる
- ユーザーは何度でもゲームを繰り返しプレイできる

**データ記録**:

- ユーザーのプレイ記録は学習履歴に自動的に記録される（記録設定が有効な場合）
- ユーザーのスコアは自動的に保存され、次回のスタート画面で確認できる

  8.7. 技術実装

- **問題生成 API**: `/api/quiz/generate` - Vercel AI SDK（OpenAI/Google Generative AI）を使用して動的に問題を生成
- **フロントエンド**: `/quiz` ページ - React の状態管理とドラッグ&ドロップ API
- **状態管理**: `useState` で 5 つのゲーム状態を管理（intro, loading, playing, finished, error）
- **タイマー**: `setInterval` を使用した秒単位カウントダウン
- **学習ログ**: `logStudyEvent` Server Action を使用して Supabase に記録
- **スコア保存**: `localStorage` にスコアデータを JSON 形式で保存
  - 保存内容: `{ score, correctAnswers, totalQuestions, date }`
  - キー: `lastQuizScore`
- **設定取得**: `getSettings` Server Action でユーザーの学習レベルを取得
- **データベース**: `study_logs` テーブルに `quiz_play` イベントタイプを追加

9. FAQ・サポート機能

   9.1. 概要
   ユーザーが困った時に自己解決できるよう、よくある質問と回答、使い方ガイド、システム情報を提供する画面を提供します。

   9.2. 主な機能

   **よくある質問（FAQ）**:

   - カテゴリ別に整理された Q&A
     - 📚 基本的な使い方
     - 🎯 学習機能について
     - ⚙️ 設定について
     - 🔐 アカウント・認証
     - 💾 データ・プライバシー
     - 🔧 トラブルシューティング
   - アコーディオン形式で開閉可能
   - 検索機能（将来拡張として検討）

   **使い方ガイド**:

   - はじめてのチャット
   - 効果的な学習方法
   - 各機能の使い方

   **機能一覧・クイックリファレンス**:

   - 主要機能の一覧表
   - 各機能へのリンク

   **更新履歴・新機能**:

   - 最近のアップデート情報
   - 新機能の紹介

   **システム要件・対応環境**:

   - 推奨ブラウザ
   - 対応デバイス
   - 音声機能の利用について

   **用語集**:

   - サービス内で使用される用語の説明

     9.3. ユーザーストーリー

   - ユーザーは困った時に FAQ で自己解決できる
   - ユーザーは使い方ガイドで機能の使い方を学べる
   - ユーザーは更新履歴で新機能を確認できる
   - ユーザーは対応環境を確認して適切なブラウザを選択できる

     9.4. 技術実装

   - 静的コンテンツとして実装（JSX + Tailwind CSS）
   - FAQ はアコーディオンコンポーネントで実装
   - ダークモード対応
   - レスポンシブデザイン
   - URL: `/faq`

10. 今後の展望・考慮事項
    レベルに応じた学習コンテンツのパーソナライズのさらなる改善
    追加のゲーム形式（リスニングクイズ、穴埋め問題など）
    コミュニティ機能
    多言語対応
    AI による学習データの分析と個別レコメンデーション
